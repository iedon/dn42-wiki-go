# DN42 Wiki Go

DN42 Wiki Go is a simple Git-backed wiki engine, designed for DN42, that serves Markdown content with a Go HTTP frontend or produces a fully static export. It keeps everything in a Git repository, supports optional in-browser editing, and can operate without an upstream remote for disconnected nodes.

This project aims to replace the old, Gollum based DN42 distributed wiki.

## Features
- Live mode with automatic pull/push scheduling and Markdown rendering.
- Offline/static mode that renders the repository into pre-built HTML under `dist/`.
- Built-in editor (when `editable` is enabled) with commit metadata controls.
- Webhook API on the primary server plus optional remote polling integration.
- Themeable layout fragments and asset pipeline bundled from `template/`.

## Quick Start
1. Install Go 1.24+ and ensure the Git CLI is available on `PATH`.
2. Copy `config.example.json` to `config.json` and adjust the settings you need.
3. Run the server in live mode(eg. Linux amd64):
   ```bash
   export GOOS=linux
   export GOARCH=amd64
   ./build.sh
   ```
4. For a static export instead, set `"live": false` in the config and run the binary, or run with `--build` flag; rendered HTML will appear in `outputDir` (default `./dist`):
   ```bash
   # Use CLI to generate site
   # The flag will force treating config.live as false
   ./dn42-wiki-go --build
   ```
5. Use `build.sh` for a one-shot build that drops the binary, templates, and example config into `dist/`.

## Webhook endpoints
When `"webhook.enabled": true` the primary HTTP server exposes:
- `GET|POST /api/webhook/pull` – trigger a `git pull` followed by static cache rebuild.
- `GET|POST /api/webhook/push` – push local commits to the configured remote.

If `webhook.secret` is non-empty, callers must provide an `Authorization` header whose value matches the secret exactly; bearer tokens (e.g. `Authorization: Bearer <token>`) are accepted for convenience.

Enabling `webhook.polling` keeps a registration active with the remote notification service and invokes the pull endpoint on every successful refresh.

## Configuration reference
Configuration is supplied as JSON. Below is a description of every option and the defaults applied when a field is omitted.

### Runtime
- `live` *(bool, default `false`)*: Run the HTTP server when `true`; render static content to `outputDir` and exit when `false`.
- `editable` *(bool, default `false`)*: Allow write endpoints (save, rename, new page). When `false` the UI becomes read-only.
- `listen` *(string, default `":8080"`)*: Address for the main HTTP server. Supports TCP (`host:port`) or `unix:/path`.
- `baseUrl` *(string, default empty)*: Optional URL prefix for hosting under a subdirectory. Used in generated links and search index URLs.
- `siteName` *(string, default `"DN42 Wiki Go"`)*: Site Name.

### Git
- `git.binPath` *(string, default `git`)*: Path to the Git executable.
- `git.remote` *(string, default empty)*: Remote URL. Leave empty for standalone/local repositories.
- `git.localDirectory` *(string, default `./repo`)*: Directory where the wiki repository is cloned or initialised.
- `git.pullIntervalSec` *(int, default `300`)*: Seconds between background `git pull` operations in live mode. Disabled if no remote is set.
- `git.author` *(string, default `"Anonymous <anonymous@localhost>"`)*: Author string used for commits generated by the application, unless a custom author is provided per request.
- `git.commitMessagePrefix` *(string, default empty)*: Optional prefix prepended verbatim to commit messages supplied by users.
- `git.commitMessageAppendRemoteAddr` *(string, default empty)*: Optional suffix appended when a request carries a remote address. If the value contains `%s` it is treated as a `fmt` format string; otherwise it is concatenated.

### Webhook
- `webhook.enabled` *(bool, default `false`)*: Expose webhook endpoints on the main HTTP server.
- `webhook.secret` *(string, default empty)*: Shared secret expected in the `Authorization` header. Ignored when empty.
- `webhook.polling.enabled` *(bool, default `false`)*: Keep a registration active with the remote notification service and trigger periodic pulls.
- `webhook.polling.endpoint` *(string, default empty)*: URL of the notification service (eg. Usage with [dn42notifyd](https://git.dn42.dev/dn42/dn42notifyd): `https://git.dn42/dn42notify/poll`).
- `webhook.polling.callbackUrl` *(string, default empty)*: Public URL for `/api/webhook/pull`. Required when `webhook.polling.enabled` is `true`.
- `webhook.polling.pollingIntervalSec` *(int, default `3600`)*: Seconds between refresh attempts. Must be positive when polling is enabled.
- `webhook.polling.skipRemoteCert` *(bool, default `false`)*: Insecure: Skip TLS verification.

### Paths and templating
- `outputDir` *(string, default `./dist`)*: Destination directory for static builds or asset exports.
- `templateDir` *(string, default `./template`)*: Location of layout templates and static assets bundled into the server/UI.
- `homeDoc` *(string, default `Home.md`)*: Repository document to treat as the home page. Normalised to a `.md` path relative to the repo root.
- `privatePagesPrefix` *(array of strings, default empty)*: Request to routes started with these prefixes will be blocked.

### Layout and footer
- `ignoreHeader` *(bool, default `false`)*: Skip loading `_Header.md` when `true`. Leave `false` to include the fragment when present.
- `ignoreFooter` *(bool, default `false`)*: Skip `_Footer.md` when `true`; otherwise render it if available.
- `serverFooter` *(string, default empty)*: Markdown snippet rendered into the global footer at runtime.

### TLS
- `enableTLS` *(bool, default `false`)*: Serve HTTPS using the provided certificate and key.
- `tlsCert` *(string)*: Path to the TLS certificate. Required only when `enableTLS` is true.
- `tlsKey` *(string)*: Path to the TLS private key. Required when `enableTLS` is true.

### Logging and client IP handling
- `logLevel` *(string, default `info`)*: Minimum log level (`debug`, `info`, `warn`, or `error`).
- `trustedProxies` *(array of strings, default empty)*: CIDR blocks or literal IPs that are trusted to populate `X-Forwarded-For`.
- `trustedRemoteAddrLevel` *(int, default `1`)*: Number of additional trusted hops to peel off when deriving the end-user IP from the forwarded chain. Values less than `1` are coerced to `1` during load.

## Development notes
- Running with `live: true` requires write access to the Git repository directory so edits can be committed.
- When `git.remote` is empty the application initialises a standalone repository and skips pull/push work.
- Template assets are copied into the static build; editing them requires rebuilding or re-running the server to refresh caches.

Refer to `config.example.json` for starter setups, and see `nginx-vhost.conf` for a sample reverse-proxy configuration.
